pipeline {
        agent any

            environment {
                    TF_VERSION = "1.6.6"
                            TF_WORKING_DIR = "./terraform"
                                    AWS_REGION = "us-west-2" // Update if needed
                                        }

                                            tools {
                                                    terraform "${TF_VERSION}"
                                                        }

                                                            stages {
                                                                    stage('Checkout') {
                                                                                steps {
                                                                                                checkout scm
                                                                                                            }
                                                                                                                    }

                                                                                                                            stage('Terraform Init') {
                                                                                                                                        steps {
                                                                                                                                                        dir("${TF_WORKING_DIR}") {
                                                                                                                                                                            sh 'terraform init'
                                                                                                                                                                                            }
                                                                                                                                                                                                        }
                                                                                                                                                                                                                }

                                                                                                                                                                                                                        stage('Terraform Format Check') {
                                                                                                                                                                                                                                    steps {
                                                                                                                                                                                                                                                    dir("${TF_WORKING_DIR}") {
                                                                                                                                                                                                                                                                        sh 'terraform fmt -check'
                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                    stage('Terraform Validate') {
                                                                                                                                                                                                                                                                                                                                steps {
                                                                                                                                                                                                                                                                                                                                                dir("${TF_WORKING_DIR}") {
                                                                                                                                                                                                                                                                                                                                                                    sh 'terraform validate'
                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                stage('Terraform Plan') {
                                                                                                                                                                                                                                                                                                                                                                                                                            steps {
                                                                                                                                                                                                                                                                                                                                                                                                                                            dir("${TF_WORKING_DIR}") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                sh 'terraform plan -out=tfplan'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            stage('Terraform Apply') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        when {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        branch 'main'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                steps {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                input message: 'Approve Terraform Apply?'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                dir("${TF_WORKING_DIR}") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sh 'terraform apply tfplan'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                post {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        failure {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo "Terraform pipeline failed."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
}